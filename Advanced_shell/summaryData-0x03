#!/usr/bin/env bash
# Script: summaryData-0x03
# Objective:
#   - Read all JSON files generated in task 2 from pokemon_data/
#   - Extract name, height, and weight for each PokÃ©mon
#   - Generate a CSV report
#   - Use awk to calculate the average height and weight
#   - Also use sed for basic text/number formatting

set -u -o pipefail

INPUT_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"

if [[ ! -d "$INPUT_DIR" ]]; then
  echo "Error: Directory $INPUT_DIR does not exist. Run ./batchProcessing-0x02 first."
  exit 1
fi

shopt -s nullglob
json_files=("$INPUT_DIR"/*.json)
shopt -u nullglob

if (( ${#json_files[@]} == 0 )); then
  echo "Error: No JSON files found in $INPUT_DIR. Make sure batchProcessing-0x02 completed successfully."
  exit 1
fi

# Write CSV header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Process each JSON file
for json_file in "${json_files[@]}"; do
  # Extract name, height (decimeters), weight (hectograms) using jq
  read -r name height_dm weight_hg <<<"$(jq -r '[.name, .height, .weight] | @tsv' "$json_file")"

  # Convert height to meters and weight to kilograms using awk
  height_m="$(awk -v h="$height_dm" 'BEGIN { printf "%.1f", h / 10 }')"
  weight_kg="$(awk -v w="$weight_hg" 'BEGIN { printf "%.1f", w / 10 }')"

  # Use sed to remove trailing .0 (e.g., 2.0 -> 2, 6.0 -> 6)
  height_m="$(echo "$height_m" | sed 's/\.0$//')"
  weight_kg="$(echo "$weight_kg" | sed 's/\.0$//')"

  # Capitalize first letter of name
  formatted_name="${name^}"

  echo "${formatted_name},${height_m},${weight_kg}" >> "$REPORT_FILE"
done

echo "CSV Report generated at: ${REPORT_FILE}"
echo

# Use awk to calculate averages from the CSV file
awk -F',' '
  NR > 1 {
    height_sum += $2
    weight_sum += $3
    count++
  }
  END {
    if (count > 0) {
      printf "Average Height: %.2f m\n", height_sum / count
      printf "Average Weight: %.2f kg\n", weight_sum / count
    } else {
      print "No data to summarize."
    }
  }
' "$REPORT_FILE"

exit 0
