#!/usr/bin/env bash
# Script: batchProcessing-0x04
# Objective:
#   - Fetch data for multiple Pokémon in parallel using background processes.
#   - Wait for all background jobs to finish before exiting.

set -u -o pipefail

POKEMON_LIST=("Bulbasaur" "Ivysaur" "Venusaur" "Charmander" "Charmeleon")
API_BASE_URL="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
ERROR_FILE="errors.txt"

mkdir -p "$OUTPUT_DIR"
touch "$ERROR_FILE"

fetch_pokemon() {
  local name="$1"
  local name_lc="${name,,}"
  local url="${API_BASE_URL}/${name_lc}"
  local output_file="${OUTPUT_DIR}/${name_lc}.json"

  echo "[PID $$] Fetching data for ${name_lc}..."

  local http_status
  http_status="$(curl -sS -w "%{http_code}" -o "$output_file" "$url" 2>>"$ERROR_FILE" || echo "000")"

  if [[ "$http_status" == "200" ]]; then
    echo "[PID $$] Saved data to ${output_file} ✅"
  else
    rm -f "$output_file"
    echo "$(date -Iseconds) - [PID $$] Error fetching ${name} (HTTP ${http_status}). URL: ${url}" >> "$ERROR_FILE"
    echo "[PID $$] Failed to fetch ${name} (HTTP ${http_status})."
  fi
}

pids=()

# Launch each fetch in the background
for pokemon in "${POKEMON_LIST[@]}"; do
  fetch_pokemon "$pokemon" &
  pids+=("$!")
done

# Wait for all background jobs
for pid in "${pids[@]}"; do
  wait "$pid"
done

echo "All parallel fetch operations have completed."
exit 0
